---
title: "Configuring Secure Connection with PEM Server"
navTitle: "Certificates Copy"
legacyRedirectsGenerated:
  # This list is generated by a script. If you need add entries, use the `legacyRedirects` key.
  - "/edb-docs/d/edb-postgres-enterprise-manager/user-guides/administrators-guide/8.0/managing_certificates.html"
# This file is moved from pem_admin/04_managing_certificates
redirects:
- /pem/latest/pem_admin/04_managing_certificates/
---
PEM, by default, supports secured SSL/TLS connections and acts as its own certificate authority (CA) to generate certificates and keys for the PEM server and agent. 

The SSL CA certificates and keys for the PEM server and agent gets generated during the PEM installation. These certificates and keys encrypt the connections between them. You can replace the PEM self-signed CA certificate and key with trusted third-party CA certificates.

## PEM self-signed CA certificate framework

The PEM server configuration script generates self-signed CA certificates and key files for the PEM backend database server. The backend database server uses these certificates and keys to authenticate and encrypt the agent connections.

The PEM server generates the certificates and key files in the data directory of the backend database server:

- `ca_certificate.crt`
- `ca_key.key`
- `root.crt`
- `root.crl`
- `server.crt`
- `server.key`

The `ca_certificate.crt` and `ca_key.key` are used during the agent registration process to generate the agent's SSL certificates and key files.

The `root.crt` file is a copy of the `ca_certificate.crt` file. You use the root certificate for the backend database server by setting the `ssl_ca_file` parameter as `root.crt` in the postgresql.conf file.

The `root.crl` file maintains the certificate revocation list of the agents. It ensures that the certificates associated with uninstalled agents are not in use.

The `server.crt` is the signed certificate for the PEM server and the `server.key` is the private key to the certificate. The PEM agent certificates get generated using this server certificate and key.

The agent connects to the PEM backend database server using the libpq interface. It establishes the connection with the self-signed SSL certificate and key files generated during the self-registration.

## PEM self-signed CA certificate expiration

The PEM agent installed with the PEM server monitors the expiration date of the `ca_certificate.crt` file. When the certificate is about to expire, PEM performs these steps:

- Makes a backup of the existing certificate files
- Creates new certificate files and appends the new CA certificate file to the `root.crt` file on the PEM server
- Creates a job to renew the certificate file of any active agents
- Restarts the PEM server

If you uninstall an agent, the certificate associated with the agent gets added to the certificate revocation list maintained in the `root.crl` file. This ensures you can't use the certificate to connect to the PEM server.

## Example: Replacing the certificates

This example shows you how to replace the self-signed certificates with the trusted CA certificates.

We have PEM 9.1 server on CentOS 7 with EPAS 14 as the backend server and a standalone agent installed on another machine. We have to replace the certificates for the backend server, standalone agent and default agent.

Perform the steps to update the self-signed SSL certificates:

1.  Make sure both the PEM agents and the PEM server are up and running.

1.  Take a backup of the existing SSL keys and certificates. The SSL keys and certificates are stored in the `data` directory under your PEM installation. For example, the default location on a Linux system is:

    `/var/lib/edb-as/x/data`, where `x` is the EDB Postgres Advanced server database version

    Copy the following files, adding an extension to each file to make the name unique:

    -   `ca_certificate.crt`
    -   `ca_key.key`
    -   `root.crt`
    -   `root.crl`
    -   `server.key`
    -   `server.crt`

    For example, to create a backup of the `ca_certificate` file with the word `old` appended to the entry, use this command:

    ```shell
    cp ca_certificate.crt ca_certificate_old.crt
    ```    

3.  Replace the certificates and keys with the CA certificates and keys

     -   Using intermediate key or root key
     -   Using certificates without key

    Steps to use intermediate or root key:

    a.  Generate a private key for the server:
 
        ```shell
        openssl genrsa -des3 -out server.key 4096
        openssl rsa -in server.key -out server.key
        ```

    b.  Generate a Certificate Signing Request (CSR) for the server:

        ```shell
        openssl req -new -key server.key -out server.csr -subj '/C=IN/ST=MH/L=Pune/O=PEM/CN=pem.enterprisedb.com'
        ```

    c. --- CA needs perform this --Generate an intermediate key pair: Use the openssl genrsa command to generate a private key for the intermediate CA:
 
    openssl genrsa -out intermediate.key 4096
 
    Create a certificate signing request (CSR): Use the openssl req command to create a CSR for the intermediate CA.
 
    openssl req -new -sha256 -key intermediate.key -out intermediate.csr
 
    Sign the intermediate CSR: Use the openssl x509 command to sign the CSR and generate a certificate for the intermediate CA. The -req option indicates that the input is a CSR, and the -CA and -CAkey options specify the root certificate and private key to use for signing the CSR.
 
    openssl x509 -req -in intermediate.csr -CA root.crt -CAkey root.key -CAcreateserial -out intermediate.crt -days 365 -extensions v3_intermediate_ca -extfile <(printf "[v3_intermediate_ca]\nsubjectKeyIdentifier=hash\nauthorityKeyIdentifier=keyid:always,issuer\nbasicConstraints=CA:true\n")
 
 
    Once the CSR has been signed by the root CA, the intermediate CA should install the signed certificate (root.crt) along with its own private key (intermediate.key).

    cat root.crt >> intermediate.crt

    e.  Create a server certificate using the intermediate key and certificate:

        ```shell
        openssl x509 -req -days 365 -in server.csr -CA intermediate.crt -CAkey intermediate.key -CAcreateserial -out server.crt
        
        # Verify that the server certificate is signed by the intermediate certificate.
        openssl verify -verbose -CAfile intermediate.crt server.crt
        __OUTPUT__
        server.crt: OK
        ```

    f. Copy the intermediate certificate and key
    
        ```shell
        cp intermediate.crt ca_certificate.crt
        cp intermediate.key ca_key.key
        # Change the owner of all the replaced keys and certs to the database user and in our case enterprisedb. 
        chown enterprisedb server.* root.* ca_* intermediate.*
        # Change the permission of the keys and certs to 600.
        chmod 600 server.* root.* ca_*  intermediate.*
        ```

    g.  Modify the following parameters in the file /var/lib/edb/as12/data/postgresql.conf or /etc/edb-as/12/main/postgresql.conf
    
        ```ini
        ssl = on
        ssl_cert_file = 'server.crt'
        ssl_key_file = 'server.key'
        ssl_ca_file = 'intermediate.crtâ€™
        # Comment out the ssl_crl_file parameter
        ```

        !!! Note 
            Do not restart the database server

    h.  Now create the following plsql function using query editor in PEM-

        ```sql
        DROP FUNCTION IF EXISTS pem.create_job_for_renewing_certs(int4[]);
        CREATE OR REPLACE FUNCTION pem.create_job_for_renewing_certs(_agents int4[] DEFAULT NULL)
        RETURNS void
        LANGUAGE 'plpgsql'
        VOLATILE
        COST 100
        AS $BODY$
        DECLARE
            v_jobid int;
            v_jobstepid int;
            cur_agent_list cursor(agents int[]) FOR 
            SELECT * FROM pem.agent a WHERE a.active = 'true' AND (agents IS NULL OR a.id = ANY(agents));
            rec_agent RECORD;
        BEGIN
            OPEN cur_agent_list(_agents);
            LOOP
                FETCH cur_agent_list INTO rec_agent;
                EXIT WHEN NOT FOUND;
                -- create a job for renew the agent certificates
                INSERT INTO pem.job(
                    jobname, jobdesc, agent_id, jobnextrun) 
                VALUES(
                    'Renew agent certificate','This job renew the agent certificate', rec_agent.id, now()) 
                RETURNING jobid INTO v_jobid;
                -- create the jobstep for the above created job
                INSERT INTO pem.jobstep(
                    jstjobid, jstname, jstdesc, jstkind, jstcode) 
                VALUES (
                    v_jobid, 'Renew agent certificate','This job step runs to renew the agent certificate.', 'i','renew_agent_certificate') RETURNING jstid INTO v_jobstepid;
                RAISE INFO 'Created a job (#% with step #%) for Agent#% (%)', v_jobid, v_jobstepid, rec_agent.id, rec_agent.description;
            END LOOP;
            CLOSE cur_agent_list;
        END
        $BODY$;
        ```

        ```sql
        # Execute the above created function-
        SELECT pem.create_job_for_renewing_certs();
        ```

    i.  Restart the PEM backend database server 
    
        ```shell
        systemctl restart edb-as-12.service
        ```

We are done, a quick sanity check is required post above steps execution as pointed below:

Agent level jobs get created which then recreate the certificates for both of the agents.



New keys and certificates get created for each agent in /root/.pem/
PEM server, agents are up and running.


I hope this blog will help you to replace the PEM default self-signed certificates with the trusted CA certificates successfully.

P.S: These steps are applicable to PEM versions 7.2 and later. Also, this blog is written when PEM 7.13 is the last released version of PEM, maybe in future releases, you can find the create_job_for_renewing_certs function in pem schema.



## Updating agent SSL certificates 

You must generate a certificate and rsa key for each agent interacting with the PEM server and copy the key and certificate to the agent.

Each agent has a unique identifier that is stored in the `pem.agent` table of the PEM database. You must replace the key and certificate files with the key or certificate that corresponds to the agent's identifier. 

In addition, you should move the `agent.key` and `agent.crt` files generated in the following steps 2 and 3 into place on their respective PEM agent host before generating the next certificate and key file pair.

Perform the following steps to generate a PEM agent certificate and key file pair:

1.  Use psql to find the number of agents and their corresponding identifiers:

    ```shell
    /usr/pgsql-x/bin/psql -U postgres -d pem --no-psqlrc -t -A -c "SELECT ID FROM pem.agent"
    ```

-   On Linux, you can also find the agent identifier and location of the keys and certificates in the `PEMagent` section of the `/etc/postgres-reg.ini` file.

-   On Windows, the information is stored in the registry:

    -   On a 64-bit Windows installation, check:

    ```shell
    HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\EnterpriseDB\PEM\agent
    ```

    -   On a 32-bit Windows installation, check:

    ```shell
    HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\PEM\agent
    ```

2.  After identifying the agents that need key files, generate an `agent.key` for each agent. To generate the key, execute the following command, capturing the output in a file:

    ```shell
    /usr/pgsql-x/bin/psql -U postgres -d pem --no-psqlrc -t -A -c "SELECT openssl_rsa_generate_key(4096)" > agent.key
    ```

    Modify the privileges of the `agent.key` file:

    ```shell
    chmod 600 agent.key
    ```

3.  To generate a certificate for each agent, execute the following command, capturing the output in a certificate file:

    ```shell
    /usr/pgsql-x/bin/psql -U postgres -d pem --no-psqlrc -t -A -c
    "SELECT openssl_csr_to_crt(openssl_rsa_key_to_csr('$(cat agent.key)',
    'agent<$ID>', 'US', 'MA', 'Bedford', 'Postgres Enterprise Manager',
    'support@enterprisedb.com'),
    '/var/lib/pgsql/x/data/ca_certificate.crt',
    '/var/lib/pgsql/x/data/ca_key.key')" > agent.crt
    ```

    Where `$ID` is the agent number of the agent (retrieved by the psql command line).

4.  Modify the privileges of the `agent.crt` file:

    ```shell
    chmod 600 agent.crt
    ```

5. Replace each agent's key and certificate file with the newly generated files before restarting the PEM agent service:


- Linux
    -   On Linux with `init.d`, restart the service with the command:

    ```shell
    /etc/init.d/pemagent start
    ```

    -   On Linux with `systemd`, restart the service with the command:

    ```shell
    systemctl start pemagent
    ```

- Windows
    - On a Windows host, you can use the Services applet to start the PEM agent. The PEM agent service is named Postgres Enterprise Manager Agent. Select the service name in the Services dialog box and select **Start the service**.

## Replacing agent SSL certificates

You can update the self-signed SSL certificates on an existing PEM installation. If you upgrade your server to a new version, first upgrade the PEM server and then the PEM agent on all PEM installations before replacing the SSL certificates. 

Perform the steps to update the self-signed SSL certificates:

1.  Stop all running PEM agents, first on the server host and then on any monitored host.

    To stop a PEM agent on a Linux host, open a terminal window, assume superuser privileges, and enter the command:


    ```shell
    # For example, on CentOS 7 or 8, running as superuser
    systemctl stop pemagent
    ```

    On a Windows host, you can use the Services applet to stop the PEM agent. The PEM agent service is named Postgres Enterprise Manager Agent. Select the service name in the Services dialog box and select **Stop the service**.

2.  Take a backup of the existing SSL certificates and keys. The SSL certificates and keys are stored in the `data` directory under your PEM installation. For example, the default location on a Linux system is:

    `/var/lib/pgsql/x/data`, where `x` is the PostgreSQL database version

    Copy the following files, adding an extension to each file to make the name unique:

    -   `ca_certificate.crt`
    -   `ca_key.key`
    -   `root.crt`
    -   `root.crl`
    -   `server.key`
    -   `server.crt`

    For example, to creates a backup of the `ca_certificate` file with the word `old` appended to the entry, use this command:

    ```shell
    # cp ca_certificate.crt ca_certificate_old.crt
    ```    

3.  Use the `openssl_rsa_generate_key()` function to generate the `ca_key.key` file:

    ```shell
    /usr/pgsql-x.x/bin/psql -U postgres -d pem --no-psqlrc -t -A -c "SELECT public.openssl_rsa_generate_key(1024)" > /var/lib/pgsql/x/data/ca_key.key
    ```

    After creating the `ca_key.key` file, `cat` the contents to the variable `CA_KEY` for use when generating the `ca_certificate.crt` file. Modify the privileges on the `ca_key.key` file:

    ```shell
    CA_KEY=$(cat /var/lib/pgsql/x/data/ca_key.key)

    chmod 600 /var/lib/pgsql/x/data/ca_key.key
    ```

4.  Use the key to generate the `ca_certificate.crt` file. For simplicity, place the SQL query in a temporary file with a unique name:

    ```shell
    echo "SELECT openssl_csr_to_crt(openssl_rsa_key_to_csr('${CA_KEY}',
    'PEM','US', 'MA', 'Bedford', 'Postgres Enterprise Manager',
    'support@enterprisedb.com'), NULL,
    '/var/lib/pgsql/x/data/ca_key.key')" > /tmp/_random.$$
    ```

    Then use the variable to execute the query, placing the content in the `ca_certificate.crt` file.

    ```shell
    /usr/pgsql-x/bin/psql -U postgres -d pem --no-psqlrc -t -A -f /tmp/_random.$$ > /var/lib/pgsql/x/data/ca_certificate.crt
    ```

    Modify the permissions of the `ca_certificate.crt` file, and remove the temporary file that contained the SQL command:

    ```shell
    chmod 600 /var/lib/pgsql/x/data/ca_certificate.crt

    rm -f /tmp/_random.$$
    ```

5.  Reuse the `ca_certificate.crt` file as the `root.crt` file:

    ```shell
    cp /var/lib/pgsql/x/data/ca_certificate.crt /var/lib/pgsql/x/data/root.crt
    ```

    Modify the permissions of the `root.crt` file:

    ```shell
    chmod 600 /var/lib/pgsql/x/data/root.crt
    ```

6.  Use the `openssl_rsa_generate_crl()` function to create the certificate revocation list (`root.crl`):

    ```shell
    /usr/pgsql-x/bin/psql -U postgres -d pem --no-psqlrc -t -A -c
     "SELECT openssl_rsa_generate_crl('/var/lib/pgsql/x/data/ca_certificate.crt', '/var/lib/pgsql/x/data/ca_key.key')" > /var/lib/pgsql/x/data/root.crl
    ```

    Modify the permissions of the `root.crl` file:

    ```shell
    chmod 600 /var/lib/pgsql/x/data/root.crl
    ```

7.  Use the `openssl_rsa_generate_key()` function to generate the `server.key` file:

    ```shell
    /usr/pgsql-x/bin/psql -U postgres -d pem --no-psqlrc -t -A -c "SELECT public.openssl_rsa_generate_key(1024)" >> /var/lib/pgsql/x/data/server.key
    ```

    After creating the `server.key` file, `cat` the contents to the variable `SSL_KEY` for use when generating the `server.crt` file and modify the privileges on the `server.key` file:

    ```shell
    SSL_KEY=$(cat /var/lib/pgsql/x/data/server.key)

    chmod 600 /var/lib/pgsql/x/data/server.key
    ```

8.  Use the `SSL_KEY` to generate the server certificate. Save the certificate in the `server.crt` file. For simplicity, first place the SQL query into a temporary file with a unique name:

    ```shell
    echo "SELECT openssl_csr_to_crt(openssl_rsa_key_to_csr('${SSL_KEY}',
    'PEM','US', 'MA', 'Bedford', 'Postgres Enterprise Manager',
    'support@enterprisedb.com'),
    '/var/lib/pgsql/x/data/ca_certificate.crt',
    '/var/lib/pgsql/x/data/ca_key.key')" > /tmp/_random.$$

     /usr/pgsql-x/bin/psql -U postgres -d pem --no-psqlrc -t -A -f /tmp/_random.$$ >> /var/lib/pgsql/x/data/server.crt
    ```

9.  Modify the privileges on the `server.crt` file, and delete the temporary file:

    ```shell
    chmod 600 /var/lib/pgsql/x/data/server.crt

    rm -f /tmp/_random.$$
    ```

10. Restart the Postgres server:

       On Linux with `init.d`, for example, on a Centos6 host:

    ```shell
    /etc/init.d/postgresql-x restart
    ```

    On Linux with `systemd`, for example, on a Centos7 host:

    ```shell
    systemctl restart postgresql-x
    ```

## Replacing PEM self-signed certificates and keys with trusted CA-signed certificates and keys

Before replacing the PEM self-signed certificates and keys with the trusted third-party CA certificates and keys, you must get those certificates using the steps indicated in the third-party CA. 

After obtaining the trusted third-party CA certificates and keys, perform the following steps: 

- Replace PEM self-signed certificates and keys with trusted CA-signed certificates and keys
- Install trusted CA root and intermediate certificates
- Install trusted CA CRL
- Disable CRL usage by the server if the trusted third-party CA does not provide CRL
- Configuring different agents to use a shared database role
