---
title: "Regenerating the agent self-signed SSL certificates"
---

If the PEM agent certificates are expiring, you can regenerate the certificates and key files.

You must regenerate a certificate and a key for each agent interacting with the PEM server and copy to the agent.

Each agent has a unique identifier that is stored in the `pem.agent` table of the `pem` database. You must replace the certificate and key files with the certificate or key files that corresponds to the agent's identifier. 

Pre-requisites:
- PEM Server has self-signed certificates.
- `ca_certificate.crt` and `ca_key.key` are in the data directory of the PEM backend database server.
- `ca_certificate.crt` is same as `root.crt`.
- `ca_ceritificate.crt` and `ca_key.key` are valid SSL certificates and keys. 

Perform the steps to generate a PEM agent certificate and key file pair:

1. Use psql to find the number of agents and their corresponding identifiers:

   ```shell
    /usr/edb/as<x>/bin/psql -p 5444 -U enterprisedb -d pem --no-psqlrc -t -A -c "SELECT ID FROM pem.agent WHERE active='true'"
    ```

1. After identifying the agents that need key files, generate an `agent.key` for each agent. To generate the key, execute the command:

    ```shell
    openssl genrsa -out agent<ID>.key 4096
   ```
   
   Where `ID` is the agent identifier obtained in step 1

1. Generate a Certificate Signing Request (CSR) for each agent:

   ```shell
   openssl req -new -key agent<ID>.key -out agent<ID>.csr -subj '/C=IN/ST=MH/L=Pune/O=PEM/CN=agent<ID>'
   ```
   
   Where `CN` is the `agent<ID>`.

1. Use the openssl x509 command to sign the CSR and generate an agent certificate:

   ```shell
   openssl x509 -req -days 365 -in agent<ID>.csr -CA ca_certificate.crt -CAkey ca_key.key -CAcreateserial -out agent<ID>.crt
   ```

   Move the `agent.key` and `agent.crt` files generated in the steps 2 and 4 on their respective PEM agent host before generating the next certificate and key file pair.

1. Change the permission on the new `agent<ID>.crt` and `agent<ID>.key` file:

   ```shell
   chmod 600 agent<ID>.crt agent<ID>.key
   ```

1. Take the backup of old agent certificate and key file:

   ```shell
   # Running as root
   mkdir root/.pem/certs
   mv root/.pem/agent<ID>.* root/.pem/certs
   ```

1. Replace each agent's certificate and key file with the newly generated files. 
   
   ```shell
   cp agent<ID>.key agent<ID>.crt root/.pem
   ```

1. Restart the PEM agent service:

   - On Linux,

     ```shell
     # Running as root
     systemctl start pemagent
     ```

    - On Windows, you can use the Services applet to start the PEM agent. The PEM agent service is named Postgres Enterprise Manager Agent. Select the service name in the Services dialog box and select **Start the service**.


