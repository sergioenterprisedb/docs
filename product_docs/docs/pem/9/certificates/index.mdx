---
title: "Managing SSL certificates"
navTitle: "Managing SSL certificates"
legacyRedirectsGenerated:
  # This list is generated by a script. If you need add entries, use the `legacyRedirects` key.
  - "/edb-docs/d/edb-postgres-enterprise-manager/user-guides/administrators-guide/8.0/managing_certificates.html"
# This file is moved from pem_admin/04_managing_certificates
redirects:
- /pem/latest/managing_certificates/
- /pem/latest/pem_admin/04_managing_certificates/
---

PEM has two types of SSL certificates:

- Webserver certificates
- PEM server and agent connection certificates

## Webserver certificates

We recommend an additional layer of SSL security for the web application.

During PEM installation, PEM generates and uses self-signed certificates for the Apache/HTTPD server. If you want to use your own SSL certificate for PEM, you must update the Apache configuration file.

On Linux, you need to open the Apache HTTPD configuration file (`edb-ssl-pem.conf`) in a text editor and be a user with write permission on the file. You must also change the server name and file names in the configuration file to match your certificate files.

Update these two SSL directives in the PEM VirtualHost section:

-   `SSLCertificateFile` is your DigiCert certificate file (for example, your_domain_name.crt).
-   `SSLCertificateKeyFile` is the .key file generated when you created the CSR (for example, your_private.key).

For example, make the following updates:

```shell
SSLEngine on
SSLCertificateFile /path/to/your_domain_name.crt
SSLCertificateKeyFile /path/to/your_private.key
```

You can also replace the HTTPD self-signed SSL certificates with trusted CA-signed certificates in PEM. For instructions, see [Replacing HTTPD self-signed SSL certificates](https://www.enterprisedb.com/postgres-tutorials/how-replacing-httpd-self-signed-ssl-certificates-trusted-ca-signed-certificates).

## PEM server and agent connection certificates

PEM, by default, supports secured SSL/TLS connections and acts as its own certificate authority (CA) to generate certificates and keys for the PEM server and agent. The self-signed SSL certificates and keys for the PEM server and agent get generated during the PEM installation. These certificates and keys encrypt the connections between the server and the agent. 

To increase the security, you can replace the PEM self-signed CA certificate and key with trusted third-party CA certificates. For more information, see [Trusted third-party CA certificates and keys](/pem/latest/certificates/#trusted-third-party-ca-certificates-and-keys).

### How PEM self-signed SSL certificates work

The PEM server configuration script generates self-signed SSL certificates and key files for the PEM backend database server. The backend database server uses these certificates and keys to authenticate and encrypt the agent connections. If you upgrade your PEM server, you need to replace the SSL certificates. For more information, see [Regenerating server self-signed SSL certificates](/pem/latest/certificates/replacing_ssl_certificates).

The PEM agent acts as a client of the PEM backend database server. It connects using the libpq interface. The client side self-signed SSL certificates and keys get generated during the [PEM registration](/pem/latest/registering_agent). PEM agent establishes the connection with the PEM backend database server using the self-signed SSL certificate and key files. 

Each agent has a unique identifier and the agent certificates and keys have the corresponding identifier mentioned. Each certificate has an expiry date. You can regenerate the certificates when it gets expired. For more information, see [Regenerating agent self-signed SSL certificates](/pem/latest/certificates/regenerating_agent_certificates).


For more information on using the SSL certificates to connect in Postgres, see [Securing TCP/IP connections with SSL](https://www.postgresql.org/docs/current/ssl-tcp.html).

### Certificate and key files generation

The PEM server generates the certificates and key files in the data directory of the backend database server:

- `ca_certificate.crt`
- `ca_key.key`
- `root.crt`
- `root.crl`
- `server.crt`
- `server.key`

The `ca_certificate.crt` and `ca_key.key` are used during the agent registration process to generate the agent's SSL certificates and key files.

The `root.crt` file is a copy of the `ca_certificate.crt` file. You use the root certificate for the backend database server by setting the `ssl_ca_file` parameter as `root.crt` in the postgresql.conf file.

The `root.crl` file maintains the certificate revocation list of the agents. It ensures that the certificates associated with uninstalled agents are not in use.

The `server.crt` is the signed certificate for the PEM server and the `server.key` is the private key to the certificate. The PEM agent certificates get generated using this server certificate and key files.

### PEM self-signed SSL certificate renewal

The PEM agent installed with the PEM server monitors the expiration date of the `ca_certificate.crt` file. When the certificate is about to expire, PEM performs these steps:

- Makes a backup of the existing certificate files
- Creates new certificate files and appends the new CA certificate file to the `root.crt` file on the PEM server
- Creates a job to renew the certificate file of any active agents
- Restarts the PEM server

If you uninstall an agent, the certificate associated with the agent gets added to the certificate revocation list maintained in the `root.crl` file. This ensures you can't use the certificate to connect to the PEM server.

## Trusted third-party CA certificates and keys

You can replace the PEM self-signed SSL certificates and keys with the trusted third-party CA certificates and keys. 

After obtaining the trusted third-party CA certificates and keys, perform the following steps: 

- Replace PEM self-signed certificates and keys with trusted CA-signed certificates and keys
- Disable CRL usage by the server if the trusted third-party CA does not provide CRL

Steps to replace self-signed SSL certificates with trusted third-party CA certificates:

1. Use psql to find the number of agents and their corresponding identifiers:

   ```shell
   /usr/edb/as<x>/bin/psql -U enerprisedb -d pem --no-psqlrc -t -A -c "SELECT ID FROM pem.agent"
   ```

   - On Linux, you can also find the agent identifier and location of the certificates and keys in the PEMagent section of the `/etc/postgres-reg.ini` file.

   - On Windows, the information is stored in the registry:

     ```shell
     HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\EnterpriseDB\PEM\agent
     ```

1. After identifying the agents that need key files, generate an `agent<ID>.key` for each agent. To generate the key, execute the command, capturing the output in a key file:

   ```shell
   /usr/edb/as<x>/bin/psql -U enerprisedb -d pem --no-psqlrc -t -A -c "SELECT openssl_rsa_generate_key(4096)" > agent<ID>.key
   ```

1. Generate a Certificate Signing Request (CSR) for each agent:

   ```shell
   openssl req -new -key agent<ID>.key -out agent<ID>.csr -subj '/C=IN/ST=MH/L=Pune/O=PEM/CN=pem.enterprisedb.com'
   ```

1. Ask your CA to sign the CSR and generate agent certificate for you. 

1. Change the permission on the new `agent<ID>.crt` and `agent<ID>.key` file:

    ```shell
    chmod 600 agent<ID>.crt agent<ID>.key
    ```

1. Take backup of old agent certificate and key file:

   ```shell
   # Running as root
   mkdir root/.pem/certs
   mv root/.pem/agent<ID>.* root/.pem/certs
   ```

1. Replace each agent's certificate and key file with the newly generated files. 
   
   ```shell
   cp agent<ID>.key agent<ID>.crt root/.pem
   ```

7. Restart the PEM agent service:

   - On Linux,

   ```shell
   # Running as root
   systemctl start pemagent
   ```

   - On a Windows, you can use the Services applet to start the PEM agent. The PEM agent service is named Postgres Enterprise Manager Agent. Select the service name in the Services dialog box and select **Start the service**.
