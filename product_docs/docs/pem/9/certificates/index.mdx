---
title: "Managing SSL certificates"
navTitle: "Managing SSL certificates"
legacyRedirectsGenerated:
  # This list is generated by a script. If you need add entries, use the `legacyRedirects` key.
  - "/edb-docs/d/edb-postgres-enterprise-manager/user-guides/administrators-guide/8.0/managing_certificates.html"
# This file is moved from pem_admin/04_managing_certificates
redirects:
- /pem/latest/managing_certificates/
- /pem/latest/pem_admin/04_managing_certificates/
---

PEM, by default, supports secured SSL/TLS connections and acts as its own certificate authority (CA) to generate certificates and keys for the PEM server and agent. The self-signed SSL certificates and keys for the PEM server and agent get generated during the PEM installation. These certificates and keys encrypt the connections between the server and the agent. 

To increase the security, you can replace the PEM self-signed CA certificate and key with trusted third-party CA certificates. For more information, see [Trusted third-party CA certificates and keys](/pem/latest/certificates/#trusted-third-party-ca-certificates-and-keys).

## How PEM self-signed SSL certificates work

The PEM server configuration script generates self-signed SSL certificates and key files for the PEM backend database server. The backend database server uses these certificates and keys to authenticate and encrypt the agent connections. If you upgrade your PEM server, you need to replace the SSL certificates. For more information, see [Replacing agent self-signed SSL certificates](/pem/latest/certificates/replacing_ssl_certificates).

The PEM agent acts as a client of the PEM backend database server. It connects using the libpq interface. The client side self-signed SSL certificates and keys get generated during the [PEM registration](/pem/latest/registering_agent). PEM agent establishes the connection with the PEM backend database server using the self-signed SSL certificate and key files. 

Each agent has a unique identifier and the agent certificates and keys have the corresponding identifier mentioned. Each certificate has an expiry date. You can regenerate the certificates when it gets expired. For more information, see [Regenerating agent self-signed SSL certificates](/pem/latest/certificates/regenerating_agent_certificates).


For more information on using the SSL certificates to connect in Postgres, see [Securing TCP/IP connections with SSL](https://www.postgresql.org/docs/current/ssl-tcp.html).

### Certificate and key files generation

The PEM server generates the certificates and key files in the data directory of the backend database server:

- `ca_certificate.crt`
- `ca_key.key`
- `root.crt`
- `root.crl`
- `server.crt`
- `server.key`

The `ca_certificate.crt` and `ca_key.key` are used during the agent registration process to generate the agent's SSL certificates and key files.

The `root.crt` file is a copy of the `ca_certificate.crt` file. You use the root certificate for the backend database server by setting the `ssl_ca_file` parameter as `root.crt` in the postgresql.conf file.

The `root.crl` file maintains the certificate revocation list of the agents. It ensures that the certificates associated with uninstalled agents are not in use.

The `server.crt` is the signed certificate for the PEM server and the `server.key` is the private key to the certificate. The PEM agent certificates get generated using this server certificate and key files.

### PEM self-signed SSL certificate renewal

The PEM agent installed with the PEM server monitors the expiration date of the `ca_certificate.crt` file. When the certificate is about to expire, PEM performs these steps:

- Makes a backup of the existing certificate files
- Creates new certificate files and appends the new CA certificate file to the `root.crt` file on the PEM server
- Creates a job to renew the certificate file of any active agents
- Restarts the PEM server

If you uninstall an agent, the certificate associated with the agent gets added to the certificate revocation list maintained in the `root.crl` file. This ensures you can't use the certificate to connect to the PEM server.

## Trusted third-party CA certificates and keys

You can replace the PEM self-signed SSL certificates and keys with the trusted third-party CA certificates and keys. Before replacing, you must get those certificates using the steps indicated in the third-party CA. 

After obtaining the trusted third-party CA certificates and keys, perform the following steps: 

- Replace PEM self-signed certificates and keys with trusted CA-signed certificates and keys
- Install trusted CA root and intermediate certificates
- Install trusted CA CRL
- Disable CRL usage by the server if the trusted third-party CA does not provide CRL

### Example

This example shows you how to replace the self-signed SSL certificates and keys with the trusted third-party CA certificates and keys.

The example uses a PEM 9.1 server on CentOS 7 with EDB Postgres Enterprise Server 14 as the backend server and a standalone agent installed on another machine. It shows replacing the certificates for the backend server, standalone agent, and default agent.

1.  Make sure both the PEM agents and the PEM server are up and running.

1. Take a backup of the existing SSL certificates and keys. The SSL certificates and keys are stored in the `data` directory under your PEM installation (`/var/lib/edb-as/14/data` in this example). 

   Copy the files, adding an extension (in this example "old") to each file to make the name unique:

   ```shell
   # Running as root
   cp ca_certificate.crt ca_certificate_old.crt
   cp ca_key.key ca_key_old.key
   cp root.crt root_old.crt
   cp root.crl root_old.crl
   cp server.key server_old.key
   cp server.crt server_old.crt
   ```    

1. Replace the certificates and keys with the CA certificates and keys. You can do so either by using an intermediate key or root key or using certificates without a key. In this example, we use an intermediate or root key.

    a. Generate a private key for the server:
 
       ```shell
       # Running as root
       openssl genrsa -des3 -out server.key 4096
       openssl rsa -in server.key -out server.key
       ```

    b. Generate a Certificate Signing Request (CSR) for the server:

       ```shell
       openssl req -new -key server.key -out server.csr -subj '/C=IN/ST=MH/L=Pune/O=PEM/CN=pem.enterprisedb.com'
       ```

    c. Ask your CA to generate an intermediate key pair and sign the intermediate CSR for your server. After root CA signs the CSR, the intermediate CA can install the `root.crt` along with its own `intermediate.key`. 
    
    d. Append your `root.crt` to `intermediate.crt`:

       ```shell
       cat root.crt >> intermediate.crt
       ```
    
    e. Create a server certificate using the intermediate key and certificate:

       ```shell
       openssl x509 -req -days 365 -in server.csr -CA intermediate.crt -CAkey intermediate.key -CAcreateserial -out server.crt
        
       # Verify the server certificate is signed by the intermediate certificate
       openssl verify -verbose -CAfile intermediate.crt server.crt
       __OUTPUT__
       server.crt: OK
       ```

    f. Copy the intermediate certificate and key files:
    
       ```shell
       cp intermediate.crt ca_certificate.crt
       cp intermediate.key ca_key.key
    
1. Change the owner of the intermediate certificate and key files to `enterprisedb` and set the permissions:
       
   ```shell
   chown enterprisedb server.* root.* ca_* intermediate.*
   chmod 600 server.* root.* ca_*  intermediate.*
   ```

1. Modify the parameters in the postgresql.conf file of the backend database server:
    
   ```ini
   # Comment the `ssl_crl_file` parameter to disable CRL usage 
   # by the server
   ssl = on
   ssl_cert_file = 'server.crt'
   ssl_key_file = 'server.key'
   ssl_ca_file = 'intermediate.crtâ€™
   ```

   Do not restart the database server at this point.

1. Create and execute the `create_job_for_renewing_certs` function using the query editor in the PEM web client. The function gets created in the `pem` schema of your backend database server. It creates a job for each registered agent to recreate all the agent certificates.

   ```sql
   # Drop the function
   DROP FUNCTION IF EXISTS pem.create_job_for_renewing_certs(int4[]);
   
   # Create the function
   CREATE OR REPLACE FUNCTION pem.create_job_for_renewing_certs(_agents int4[] DEFAULT NULL)
       RETURNS void
       LANGUAGE 'plpgsql'
       VOLATILE
       COST 100
       AS $BODY$
       DECLARE
            v_jobid int;
            v_jobstepid int;
            cur_agent_list cursor(agents int[]) FOR 
            SELECT * FROM pem.agent a WHERE a.active = 'true' AND (agents IS NULL OR a.id = ANY(agents));
            rec_agent RECORD;
       BEGIN
            OPEN cur_agent_list(_agents);
            LOOP
                FETCH cur_agent_list INTO rec_agent;
                EXIT WHEN NOT FOUND;
                -- create a job for renew the agent certificates
                INSERT INTO pem.job(
                    jobname, jobdesc, agent_id, jobnextrun) 
                VALUES(
                    'Renew agent certificate','This job renew the agent certificate', rec_agent.id, now()) 
                RETURNING jobid INTO v_jobid;
                -- create the jobstep for the above created job
                INSERT INTO pem.jobstep(
                    jstjobid, jstname, jstdesc, jstkind, jstcode) 
                VALUES (
                    v_jobid, 'Renew agent certificate','This job step runs to renew the agent certificate.', 'i','renew_agent_certificate') RETURNING jstid INTO v_jobstepid;
                RAISE INFO 'Created a job (#% with step #%) for Agent#% (%)', v_jobid, v_jobstepid, rec_agent.id, rec_agent.description;
            END LOOP;
            CLOSE cur_agent_list;
       END
       $BODY$;
    
    # Execute the above created function
    SELECT pem.create_job_for_renewing_certs();
    ```

1. Restart the PEM backend database server: 
    
   ```shell
   # Running as root
   systemctl restart edb-as-14.service
   ```

   Each agent's new certificates and keys are in `/root/.pem`.

   To do a sanity check that all the agent-level jobs have completed successfully, go to the PEM agents in the browser tree and check the status of the scheduled tasks. If the jobs completed successfully, the PEM server and agents are up and running using new certificates and keys.

### Example

This example shows you how to replace the self-signed SSL certificates with the trusted third-party CA certificates without keys.

The example uses a PEM 9.1 server on CentOS 7 with EDB Postgres Enterprise Server 14 as the backend server and a standalone agent installed on another machine. It shows replacing the certificates for the backend server, standalone agent, and default agent.

Perform the steps to generate a PEM agent certificate and key file pair:

1. Use psql to find the number of agents and their corresponding identifiers:

   ```shell
   /usr/pgsql-x/bin/psql -U postgres -d pem --no-psqlrc -t -A -c "SELECT ID FROM pem.agent"
   ```

   - On Linux, you can also find the agent identifier and location of the certificates and keys in the `PEMagent` section of the `/etc/postgres-reg.ini` file.

   - On Windows, the information is stored in the registry:

     ```shell
     HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\EnterpriseDB\PEM\agent
     ```

1. After identifying the agents that need key files, generate an `agent.key` for each agent. To generate the key, execute the command, capturing the output in a key file:

    ```shell
    /usr/pgsql-x/bin/psql -U enterprisedb -d pem --no-psqlrc -t -A -c "SELECT openssl_rsa_generate_key(4096)" > agent.key
    ```

1. CA needs each agents information to generate the new certificates. Collect the information for each agent like `agentID` or `agent name`, `country name`, `state`, `location` or `city`, `organization` and `emailID`. Using this information CA generates new certificates for each agent.

1. Change the permission on the `agent.crt` file:

    ```shell
    chmod 600 agent.crt
    ```

1. Replace each agent's certificate and key file with the newly generated files. 

1. Take backup of agent certificate

   ```shell
   # Running as root
   mkdir root/.pem/certs
   mv root/.pem/agent1.* root/.pem/certs

1. Rename the new `agent.key` and `agent.crt` to `agent<ID>.key` and `agent<ID>.crt` respectively.

1. Copy the new `agent<ID>.key` and `agent<ID>.crt` to root/.pem
